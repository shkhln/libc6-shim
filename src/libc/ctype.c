#include <assert.h>
#include <ctype.h>
#include <stdint.h>
#include <stdlib.h>
#include "../shim.h"
#include "locale.h"

// TODO: __ctype32_b, __ctype32_tolower, __ctype32_toupper?

static uint16_t shim_ctype_b_table[384] = {
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x2003, 0x2002, 0x2002, 0x2002, 0x2002, 0x0002, 0x0002,
  0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002,
  0x6001, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004,
  0xd808, 0xd808, 0xd808, 0xd808, 0xd808, 0xd808, 0xd808, 0xd808, 0xd808, 0xd808, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004,
  0xc004, 0xd508, 0xd508, 0xd508, 0xd508, 0xd508, 0xd508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508,
  0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc508, 0xc004, 0xc004, 0xc004, 0xc004, 0xc004,
  0xc004, 0xd608, 0xd608, 0xd608, 0xd608, 0xd608, 0xd608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608,
  0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc608, 0xc004, 0xc004, 0xc004, 0xc004, 0x0002,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

const uint16_t* shim___ctype_b = &shim_ctype_b_table[128];

SHIM_EXPORT(__ctype_b);

const unsigned short** shim___ctype_b_loc_impl() {
  return &shim___ctype_b;
}

size_t shim___ctype_get_mb_cur_max_impl() {
  return MB_CUR_MAX;
}

static int32_t  shim_ctype_tolower_table[384];
static int32_t  shim_ctype_toupper_table[384];

__attribute__((constructor))
static void ctype_init() {
  // TODO: set locale to C here?
  for (int i = 0; i < 384; i++) {
    shim_ctype_tolower_table[i] = (i == 127 ? -1 : tolower((uint8_t)(i + 128)));
    shim_ctype_toupper_table[i] = (i == 127 ? -1 : toupper((uint8_t)(i + 128)));
  }
}

int32_t* shim___ctype_tolower = &shim_ctype_tolower_table[128];
int32_t* shim___ctype_toupper = &shim_ctype_toupper_table[128];

SHIM_EXPORT(__ctype_tolower);
SHIM_EXPORT(__ctype_toupper);

int32_t** shim___ctype_tolower_loc_impl() {
  return &shim___ctype_tolower;
}

int32_t** shim___ctype_toupper_loc_impl() {
  return &shim___ctype_toupper;
}

SHIM_WRAP(__ctype_b_loc);
SHIM_WRAP(__ctype_get_mb_cur_max);
SHIM_WRAP(__ctype_tolower_loc);
SHIM_WRAP(__ctype_toupper_loc);

int shim_isalnum_l_impl(int c, linux_locale_t loc) {
  return isalnum_l(c, loc->native_locale);
}

int shim_isalpha_l_impl(int c, linux_locale_t loc) {
  return isalpha_l(c, loc->native_locale);
}

int shim_isblank_l_impl(int c, linux_locale_t loc) {
  return isblank_l(c, loc->native_locale);
}

int shim_iscntrl_l_impl(int c, linux_locale_t loc) {
  return iscntrl_l(c, loc->native_locale);
}

int shim_isdigit_l_impl(int c, linux_locale_t loc) {
  return isdigit_l(c, loc->native_locale);
}

int shim_isgraph_l_impl(int c, linux_locale_t loc) {
  return isgraph_l(c, loc->native_locale);
}

int shim_islower_l_impl(int c, linux_locale_t loc) {
  return islower_l(c, loc->native_locale);
}

int shim_isprint_l_impl(int c, linux_locale_t loc) {
  return isprint_l(c, loc->native_locale);
}

int shim_ispunct_l_impl(int c, linux_locale_t loc) {
  return ispunct_l(c, loc->native_locale);
}

int shim_isspace_l_impl(int c, linux_locale_t loc) {
  return isspace_l(c, loc->native_locale);
}

int shim_isupper_l_impl(int c, linux_locale_t loc) {
  return isupper_l(c, loc->native_locale);
}

int shim_isxdigit_l_impl(int c, linux_locale_t loc) {
  return isxdigit_l(c, loc->native_locale);
}

SHIM_WRAP(isalnum_l);
SHIM_WRAP(isalpha_l);
SHIM_WRAP(isblank_l);
SHIM_WRAP(iscntrl_l);
SHIM_WRAP(isdigit_l);
SHIM_WRAP(isgraph_l);
SHIM_WRAP(islower_l);
SHIM_WRAP(isprint_l);
SHIM_WRAP(ispunct_l);
SHIM_WRAP(isspace_l);
SHIM_WRAP(isupper_l);
SHIM_WRAP(isxdigit_l);

int shim_tolower_l_impl(int c, linux_locale_t loc) {
  return tolower_l(c, loc->native_locale);
}

int shim_toupper_l_impl(int c, linux_locale_t loc) {
  return toupper_l(c, loc->native_locale);
}

SHIM_WRAP(tolower_l);
SHIM_WRAP(toupper_l);
